name: Deploy Godot project to GitHub Pages and Itch.io

on:
  push:
    branches: ["**"]
    tags: ["**"]

  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  BLENDER_VERSION: 4.3.2
  GODOT_VERSION: 4.5.1

jobs:
  build:
    environment:
      name: github-pages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Blender
        id: cache-blender
        uses: actions/cache@v5
        with:
          path: $HOME/blender-${{ env.BLENDER_VERSION }}
          key: blender-${{ env.BLENDER_VERSION }}-cache

      - name: Cache Godot
        id: cache-godot
        uses: actions/cache@v5
        with:
          path: Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64
          key: godot-${{ env.GODOT_VERSION }}-cache

      - name: Install Blender
        if: steps.cache-blender.outputs.cache-hit != 'true'
        run: |
          BLENDER_MAJOR_VERSION=$(echo $BLENDER_VERSION | cut -d. -f1,2)
          wget "https://download.blender.org/release/Blender${BLENDER_MAJOR_VERSION}/blender-${BLENDER_VERSION}-linux-x64.tar.xz"
          tar -xvf blender-${BLENDER_VERSION}-linux-x64.tar.xz
          mkdir -p ~/blender-${BLENDER_VERSION}
          mv blender-${BLENDER_VERSION}-linux-x64/* ~/blender-${BLENDER_VERSION}/

      - name: Copy Godot editor settings
        run: |
          mkdir ~/.config/godot
          cp editor_settings-4.tres ~/.config/godot

      - name: Download Godot editor
        if: steps.cache-godot.outputs.cache-hit != 'true'
        run: |
          wget -q "https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}-stable/Godot_v${GODOT_VERSION}-stable_linux.x86_64.zip" -O godot.zip
          unzip -q godot.zip -d .

      - name: Download Godot export templates
        run: |
          wget -q "https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}-stable/Godot_v${GODOT_VERSION}-stable_export_templates.tpz" -O templates.tpz
          mkdir -p "$HOME/.local/share/godot/templates/${GODOT_VERSION}"
          unzip -q templates.tpz -d "$HOME/.local/share/godot/templates/${GODOT_VERSION}"

      - name: Export HTML build
        run: |
          mkdir -p ./build/html
          Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64 --headless --path . --export-release "html" ./build/html/index.html

      - name: Export Windows build
        run: |
          mkdir -p ./build/windows
          Godot_v${{ env.GODOT_VERSION }}-stable_linux.x86_64 --headless --path . --export-release "windows" ./build/windows/nautilus.exe
      - name: List files
        run: tree
      - name: Fail if commit message contains 'wip'
        run: |
          if git log -1 --pretty=%B | grep -iq 'wip'; then
            echo "Deployment blocked: commit message contains 'wip'."
            exit 1
          fi

      - name: Upload HTML artifact
        uses: actions/upload-artifact@v4
        with:
          name: html
          path: build/html/

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: build/windows/

      - name: Release
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          files: |
            build/html/*
            build/windows/*

  github-pages:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download HTML artifact
        uses: actions/download-artifact@v4
        with:
          name: html
          path: build/html/

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/html/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  itch-io:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        channel: [html, windows]
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.channel }}
          path: build/${{ matrix.channel }}

      - name: List files
        run: tree

      - uses: Ayowel/butler-to-itch@v1
        with:
          butler_key: ${{ secrets.BUTLER_API_KEY }}
          itch_user: martindelille
          itch_game: nautilus
          files: |
            ${{ matrix.channel }} build/${{ matrix.channel }}
